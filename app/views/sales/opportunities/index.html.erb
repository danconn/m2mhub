<%= render 'sales/submenu' %>
<br />

<% content_for :javascripts do %>
<script type="text/javascript">
$(function() {
	$("input#search_customer_name").autocomplete({
		source: "<%= customers_url %>",
		search: function(event, ui) { 
			$("input#search_customer_name").autocomplete("close");
			$("#customer_inprogress").show();
		},
		open: function(event, ui) { 
			$("#customer_inprogress").hide();
		},
		select: function(event, ui) { 
			if (ui.item.value == "No Results") {
				$(this).val( "" ); 
				// Do nothing.
			}	else {
				$(this).val( ui.item.value ); 
			}
			return false; 
		}		
	});
})
</script>
<% end %>

<%= semantic_form_for @search, :as => :search, :url => opportunities_url, :html => {:method => :get} do |f| %>
<table class="flatform">
	<tbody>
		<tr>
			<td>
				<%= f.inputs do %>
					<%= f.input :status, :collection => Sales::OpportunityStatus.all, :prompt => 'All', :wrapper_html => { :class => 'opportunity_search_status' } %>
					<li class="flat string input optional stringish" id="sales_opportunity_customer_name_input">
						<label class=" label" for="search_customer_name"><%= Sales::Opportunity.human_attribute_name(:customer_name) %></label>
						<%= f.text_field :customer_name %>
						<span id="customer_inprogress" class="hide">
						<%= image_tag AppConfig.in_progress_image %>
						</span>
					</li>
				<% end %>
			</td>
		</tr>
		<tr>
			<td>
				<%= f.buttons do %>
				  <%= f.commit_button 'Search' %>
					<li><%= link_to 'New Opportunity', new_opportunity_path %></li>
				<% end %>
			</td>
		</tr>
	</tbody>
</table>
<% end %>

<%= set_focus('#search_company_name') %>

<% if @opportunities.size > 0 %>
<%= will_paginate @opportunities %>
<table class="data">
	<thead>
		<tr>
			<th class="fixshortname">Title</th>
			<th class="fixshortname">Customer</th>
			<th>Product</th>
			<th>Amount</th>
			<th>Status</th>
			<th>Last Update</th>
			<th>Wakeup</th>
		</tr>
	</thead>
	<tbody>
		<% @opportunities.each do |o| %>
		<tr>
			<td><%= link_to o.number_and_title, opportunity_url(o) %></td>
			<td><%= o.customer.present? ? link_to(o.customer_name, customer_url(o.customer)) : o.customer_name %></td>
			<td><%= o.product %></td>
			<td><%= cm o.amount, :rounded_dollars %></td>
			<td><%= o.status.try(:name) %></td>
			<td><%= o.updated_at.to_s(:short_human_date_time) %></td>
			<td><%= o.wakeup.to_s(:short_human_date) if o.status.hold? and o.wakeup %></td>
		</tr>
		<% end %>
	</tbody>
</table>			
<% end %>
